<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>LLM Bias Lab</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css" />
        <style>
            body {
                font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
                background-color: #f8f9fa;
            }
            .main-container {
                padding: 20px;
                max-width: 1800px;
                margin: 0 auto;
            }
            .chat-panel, .logs-panel {
                background: white;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                height: calc(100vh - 120px);
                display: flex;
                flex-direction: column;
            }
            .panel-header {
                padding: 15px 20px;
                border-bottom: 1px solid #dee2e6;
                background-color: #f8f9fa;
                border-radius: 8px 8px 0 0;
            }
            .panel-header h5 {
                margin: 0;
                font-weight: 600;
            }
            .messages-container {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }
            .message {
                padding: 10px 15px;
                border-radius: 8px;
                max-width: 80%;
                word-wrap: break-word;
                white-space: pre-wrap;
            }
            .message.user {
                align-self: flex-end;
                background: #0d6efd;
                color: white;
            }
            .message.assistant {
                align-self: flex-start;
                background: #e9ecef;
                color: #212529;
            }
            .input-section {
                padding: 20px;
                border-top: 1px solid #dee2e6;
                background-color: #f8f9fa;
                border-radius: 0 0 8px 8px;
            }
            .logs-container {
                flex: 1;
                overflow-y: auto;
                padding: 20px;
            }
            .log-entry {
                margin-bottom: 15px;
                border: 1px solid #dee2e6;
                border-radius: 6px;
                background: #f8f9fa;
            }
            .log-header {
                padding: 12px 15px;
                background: #e9ecef;
                border-bottom: 1px solid #dee2e6;
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
                border-radius: 6px 6px 0 0;
            }
            .log-header:hover {
                background: #dee2e6;
            }
            .log-header.active {
                background: #0d6efd;
                color: white;
            }
            .log-content {
                padding: 15px;
                display: none;
            }
            .log-content.show {
                display: block;
            }
            .log-timestamp {
                font-size: 0.85rem;
                color: #6c757d;
                margin-bottom: 10px;
            }
            .log-section {
                margin-bottom: 15px;
            }
            .log-section-title {
                font-weight: 600;
                margin-bottom: 8px;
                color: #495057;
            }
            .json-viewer {
                background: #282c34;
                color: #abb2bf;
                padding: 15px;
                border-radius: 6px;
                font-family: 'Fira Code', 'Courier New', monospace;
                font-size: 0.875rem;
                overflow-x: auto;
                border: 1px solid #3e4451;
                position: relative;
            }
            .json-viewer pre {
                margin: 0;
                padding: 0;
                background: transparent;
                color: inherit;
                font-family: inherit;
                font-size: inherit;
            }
            .json-viewer code {
                background: transparent;
                color: inherit;
                padding: 0;
                font-family: inherit;
                font-size: inherit;
            }
            .json-viewer .hljs {
                background: transparent;
                padding: 0;
            }
            .badge-custom {
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.75rem;
                font-weight: 500;
            }
            .badge-logit-bias {
                background-color: #ffc107;
                color: #000;
            }
            .empty-logs {
                text-align: center;
                padding: 40px;
                color: #6c757d;
            }
            .empty-logs i {
                font-size: 3rem;
                margin-bottom: 10px;
                opacity: 0.5;
            }
        </style>
    </head>
    <body>
        <div class="main-container">
            <header class="text-center mb-4">
                <h1 class="display-5 fw-bold">LLM Bias Lab</h1>
                <p class="text-muted">Chatbot playground for experimenting with bias and logit_bias</p>
            </header>
            
            <div class="row g-3">
                <!-- Left Panel: Chatbot -->
                <div class="col-md-6">
                    <div class="chat-panel">
                        <div class="panel-header">
                            <h5><i class="bi bi-chat-dots"></i> Chatbot</h5>
                        </div>
                        <div class="messages-container" id="messages"></div>
                        <div class="input-section">
                            <div class="mb-3">
                                <label for="logitBias" class="form-label">
                                    <i class="bi bi-sliders"></i> Logit Bias String
                                </label>
                                <input 
                                    type="text" 
                                    class="form-control" 
                                    id="logitBias" 
                                    placeholder="e.g., 'fetch', 'time'" 
                                />
                            </div>
                            <div class="mb-3">
                                <label for="logitBiasValue" class="form-label">
                                    <i class="bi bi-123"></i> Logit Bias Value (-100 to 100)
                                </label>
                                <input 
                                    type="number" 
                                    class="form-control" 
                                    id="logitBiasValue" 
                                    min="-100" 
                                    max="100" 
                                    value="-100"
                                    placeholder="Enter bias value (-100 to 100)" 
                                />
                                <div class="form-text">Default: -100 (strongly discourage tokens)</div>
                            </div>
                            <div class="mb-3">
                                <label for="input" class="form-label">
                                    <i class="bi bi-chat-left-text"></i> Message
                                </label>
                                <textarea 
                                    class="form-control" 
                                    id="input" 
                                    rows="3"
                                    placeholder="Type your message..." 
                                ></textarea>
                            </div>
                            <button class="btn btn-primary w-100" id="send">
                                <i class="bi bi-send"></i> Send
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Right Panel: Logs -->
                <div class="col-md-6">
                    <div class="logs-panel">
                        <div class="panel-header d-flex justify-content-between align-items-center">
                            <h5><i class="bi bi-list-ul"></i> Graph Invoke Logs</h5>
                            <button class="btn btn-sm btn-outline-secondary" id="clearLogs">
                                <i class="bi bi-trash"></i> Clear
                            </button>
                        </div>
                        <div class="logs-container" id="logs">
                            <div class="empty-logs">
                                <i class="bi bi-inbox"></i>
                                <p>No logs yet. Send a message to see graph.invoke results.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/json.min.js"></script>
        <script>
            (function () {
                const messagesEl = document.getElementById("messages");
                const logsEl = document.getElementById("logs");
                const inputEl = document.getElementById("input");
                const logitBiasEl = document.getElementById("logitBias");
                const logitBiasValueEl = document.getElementById("logitBiasValue");
                const sendBtn = document.getElementById("send");
                const clearLogsBtn = document.getElementById("clearLogs");

                function appendMessage(role, content) {
                    const emptyState = logsEl.querySelector(".empty-logs");
                    if (emptyState && role === "user") {
                        emptyState.remove();
                    }

                    const div = document.createElement("div");
                    div.className = "message " + role;
                    div.textContent = content;
                    messagesEl.appendChild(div);
                    messagesEl.scrollTop = messagesEl.scrollHeight;
                }

                function formatJSON(obj) {
                    try {
                        return JSON.stringify(obj, null, 2);
                    } catch (e) {
                        return String(obj);
                    }
                }

                function highlightJSON(jsonString, container) {
                    // Create pre and code elements for highlight.js
                    // highlight.js automatically escapes HTML, so we don't need manual escaping
                    const pre = document.createElement('pre');
                    const code = document.createElement('code');
                    code.className = 'language-json';
                    code.textContent = jsonString;
                    
                    pre.appendChild(code);
                    container.appendChild(pre);
                    
                    // Highlight the JSON
                    hljs.highlightElement(code);
                }

                function createLogEntry(logData) {
                    const logEntry = document.createElement("div");
                    logEntry.className = "log-entry";
                    
                    const header = document.createElement("div");
                    header.className = "log-header";
                    
                    const headerContent = document.createElement("div");
                    headerContent.innerHTML = `
                        <div>
                            <strong>Request ${logData.index || ''}</strong>
                            ${logData.logs.logitBiasString ? 
                                `<span class="badge badge-custom badge-logit-bias ms-2">
                                    <i class="bi bi-filter"></i> ${logData.logs.logitBiasString}
                                    ${logData.logs.logitBiasValue !== undefined ? ` (${logData.logs.logitBiasValue})` : ''}
                                </span>` : 
                                ''
                            }
                        </div>
                        <i class="bi bi-chevron-down"></i>
                    `;
                    
                    header.appendChild(headerContent);
                    
                    const content = document.createElement("div");
                    content.className = "log-content";
                    
                    // Create timestamp
                    const timestampDiv = document.createElement("div");
                    timestampDiv.className = "log-timestamp";
                    timestampDiv.innerHTML = `<i class="bi bi-clock"></i> ${new Date(logData.logs.timestamp).toLocaleString()}`;
                    content.appendChild(timestampDiv);
                    
                    // Create Messages section
                    const messagesSection = document.createElement("div");
                    messagesSection.className = "log-section";
                    const messagesTitle = document.createElement("div");
                    messagesTitle.className = "log-section-title";
                    messagesTitle.innerHTML = '<i class="bi bi-chat-left"></i> Messages';
                    messagesSection.appendChild(messagesTitle);
                    
                    const messagesViewer = document.createElement("div");
                    messagesViewer.className = "json-viewer";
                    highlightJSON(formatJSON(logData.logs.messages), messagesViewer);
                    messagesSection.appendChild(messagesViewer);
                    content.appendChild(messagesSection);
                    
                    // Create Logit Bias section (if available)
                    if (logData.logs.computedLogitBias) {
                        const logitBiasSection = document.createElement("div");
                        logitBiasSection.className = "log-section";
                        const logitBiasTitle = document.createElement("div");
                        logitBiasTitle.className = "log-section-title";
                        logitBiasTitle.innerHTML = '<i class="bi bi-diagram-3"></i> Computed Logit Bias (Token ID â†’ Bias Value)';
                        logitBiasSection.appendChild(logitBiasTitle);
                        
                        const logitBiasViewer = document.createElement("div");
                        logitBiasViewer.className = "json-viewer";
                        highlightJSON(formatJSON(logData.logs.computedLogitBias), logitBiasViewer);
                        logitBiasSection.appendChild(logitBiasViewer);
                        content.appendChild(logitBiasSection);
                    }
                    
                    // Create Full Result section
                    const fullResultSection = document.createElement("div");
                    fullResultSection.className = "log-section";
                    const fullResultTitle = document.createElement("div");
                    fullResultTitle.className = "log-section-title";
                    fullResultTitle.innerHTML = '<i class="bi bi-code-slash"></i> Full Result';
                    fullResultSection.appendChild(fullResultTitle);
                    
                    const fullResultViewer = document.createElement("div");
                    fullResultViewer.className = "json-viewer";
                    highlightJSON(formatJSON(logData.logs.fullResult), fullResultViewer);
                    fullResultSection.appendChild(fullResultViewer);
                    content.appendChild(fullResultSection);
                    
                    header.addEventListener("click", () => {
                        const isActive = header.classList.contains("active");
                        const chevron = header.querySelector(".bi-chevron-down");
                        
                        if (isActive) {
                            header.classList.remove("active");
                            content.classList.remove("show");
                            chevron.classList.remove("bi-chevron-up");
                            chevron.classList.add("bi-chevron-down");
                        } else {
                            header.classList.add("active");
                            content.classList.add("show");
                            chevron.classList.remove("bi-chevron-down");
                            chevron.classList.add("bi-chevron-up");
                        }
                    });
                    
                    logEntry.appendChild(header);
                    logEntry.appendChild(content);
                    
                    return logEntry;
                }

                function addLogEntry(logs) {
                    const emptyState = logsEl.querySelector(".empty-logs");
                    if (emptyState) {
                        emptyState.remove();
                    }

                    const logEntry = createLogEntry({
                        logs: logs,
                        index: logsEl.children.length + 1
                    });
                    
                    logsEl.insertBefore(logEntry, logsEl.firstChild);
                }

                async function sendMessage() {
                    const text = inputEl.value.trim();
                    if (!text) return;
                    
                    const logitBiasString = logitBiasEl.value.trim();
                    let logitBiasValue = undefined;
                    
                    // Parse and validate logit bias value
                    if (logitBiasValueEl.value && logitBiasValueEl.value.trim() !== "") {
                        const parsed = parseInt(logitBiasValueEl.value, 10);
                        if (isNaN(parsed)) {
                            alert("Logit Bias Value must be a valid number");
                            return;
                        }
                        if (parsed < -100 || parsed > 100) {
                            alert("Logit Bias Value must be between -100 and 100");
                            return;
                        }
                        logitBiasValue = parsed;
                    }
                    
                    const biasInfo = logitBiasString ? 
                        ` (logit_bias: ${logitBiasString}${logitBiasValue !== undefined ? ` = ${logitBiasValue}` : ''})` : '';
                    appendMessage("user", text + biasInfo);
                    const originalText = text;
                    inputEl.value = "";
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
                    
                    try {
                        const response = await fetch("/api/chat", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ 
                                content: originalText, 
                                logit_bias_string: logitBiasString || undefined,
                                logit_bias_value: logitBiasValue
                            }),
                        });
                        const data = await response.json();
                        if (!data.success) throw new Error(data.error || "Request failed");
                        
                        appendMessage("assistant", data.result || "");
                        
                        // Add log entry
                        if (data.logs) {
                            addLogEntry(data.logs);
                        }
                    } catch (error) {
                        appendMessage("assistant", "Error: " + error.message);
                    } finally {
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="bi bi-send"></i> Send';
                        inputEl.focus();
                    }
                }

                clearLogsBtn.addEventListener("click", () => {
                    logsEl.innerHTML = `
                        <div class="empty-logs">
                            <i class="bi bi-inbox"></i>
                            <p>No logs yet. Send a message to see graph.invoke results.</p>
                        </div>
                    `;
                });

                sendBtn.addEventListener("click", sendMessage);
                inputEl.addEventListener("keydown", (event) => {
                    if (event.key === "Enter" && !event.shiftKey) {
                        event.preventDefault();
                        sendMessage();
                    }
                });
            })();
        </script>
    </body>
</html>
